# Data Model Design

**Feature**: FitFusion AI Workout App  
**Date**: 2025-09-23  
**Status**: Complete

## Entity Overview

The FitFusion app uses 6 core entities to manage user profiles, workout generation, and progress tracking. The data model supports offline-first architecture with eventual consistency and last-write-wins conflict resolution.

## Core Entities

### UserProfile
Represents individual user with fitness goals and preferences for AI workout generation.

**Fields**:
- `id` (UUID, Primary Key): Unique user identifier
- `created_at` (Timestamp): Account creation date
- `updated_at` (Timestamp): Last profile modification
- `fitness_goals` (JSON Array): Selected goals ["weight_loss", "strength", "endurance", "flexibility"]
- `experience_level` (Enum): "beginner" | "intermediate" | "advanced"
- `physical_attributes` (JSON): Height, weight, age, gender (optional)
- `space_constraints` (JSON): Available space dimensions and characteristics
- `noise_preferences` (JSON): Acceptable noise levels and quiet hours
- `scheduling_preferences` (JSON): Preferred workout times and frequency
- `ai_coaching_settings` (JSON): Agent behavior preferences and personality settings

**Relationships**:
- One-to-Many with Equipment
- One-to-Many with WorkoutProgram
- One-to-Many with ProgressRecord

**Validation Rules**:
- `fitness_goals` must contain at least one valid goal
- `experience_level` required for AI generation
- `physical_attributes.age` must be 13+ if provided
- `scheduling_preferences.frequency` must be 1-7 days per week

### Equipment
Represents available exercise equipment with specifications for AI matching.

**Fields**:
- `id` (UUID, Primary Key): Unique equipment identifier  
- `user_id` (UUID, Foreign Key): Owner reference
- `created_at` (Timestamp): Equipment addition date
- `updated_at` (Timestamp): Last modification
- `name` (String): Equipment name (e.g., "Adjustable Dumbbells")
- `category` (Enum): "weights" | "cardio" | "resistance" | "bodyweight" | "flexibility"
- `specifications` (JSON): Weight ranges, resistance levels, size constraints
- `space_requirements` (JSON): Floor space and ceiling height needed
- `noise_characteristics` (JSON): Noise level and type during use
- `condition` (Enum): "excellent" | "good" | "fair" | "needs_repair"
- `is_available` (Boolean): Currently usable status

**Relationships**:
- Many-to-One with UserProfile
- Many-to-Many with Exercise (through ExerciseEquipment)

**Validation Rules**:
- `name` must be non-empty and under 100 characters
- `specifications` must match category requirements
- `space_requirements` must have positive dimensions
- Equipment marked `needs_repair` excluded from AI generation

### Exercise
Represents individual exercise movements with instructions and requirements.

**Fields**:
- `id` (UUID, Primary Key): Unique exercise identifier
- `created_at` (Timestamp): Exercise creation date  
- `updated_at` (Timestamp): Last modification
- `name` (String): Exercise name (e.g., "Push-ups", "Dumbbell Rows")
- `description` (Text): Detailed exercise instructions
- `difficulty_level` (Enum): "beginner" | "intermediate" | "advanced" | "expert"
- `muscle_groups` (JSON Array): Primary and secondary muscle groups targeted
- `exercise_type` (Enum): "strength" | "cardio" | "flexibility" | "balance" | "warmup" | "cooldown"
- `duration_type` (Enum): "reps" | "duration" | "distance" | "calories"
- `demonstration_media` (JSON): URLs for images, videos, animations
- `equipment_requirements` (JSON Array): Required and optional equipment
- `space_requirements` (JSON): Minimum space needed
- `noise_level` (Enum): "silent" | "quiet" | "moderate" | "loud"
- `modifications` (JSON Array): Easier and harder variations
- `safety_notes` (Text): Important safety considerations

**Relationships**:
- Many-to-Many with Equipment (through ExerciseEquipment)
- One-to-Many with WorkoutExercise (exercise instances in workouts)

**Validation Rules**:
- `name` must be unique and under 200 characters
- `muscle_groups` must contain at least one valid muscle group
- `demonstration_media` URLs must be accessible
- `modifications` must include at least one easier variation for beginners

### WorkoutProgram  
Represents complete multi-day fitness programs generated by AI agents.

**Fields**:
- `id` (UUID, Primary Key): Unique program identifier
- `user_id` (UUID, Foreign Key): Program owner
- `created_at` (Timestamp): Program generation date
- `updated_at` (Timestamp): Last modification
- `name` (String): Program name (AI-generated or user-modified)
- `description` (Text): Program overview and goals  
- `total_days` (Integer): Program duration in days
- `difficulty_level` (Enum): "beginner" | "intermediate" | "advanced"
- `program_type` (Enum): "strength" | "cardio" | "hiit" | "yoga" | "mixed"
- `ai_generation_metadata` (JSON): Agent attribution, parameters used, generation timestamp
- `daily_schedules` (JSON Array): Day-by-day workout structures
- `progression_logic` (JSON): How difficulty increases over time
- `completion_percentage` (Float): 0.0-1.0 progress through program
- `is_active` (Boolean): Currently selected program
- `is_completed` (Boolean): Program finished status

**Relationships**:
- Many-to-One with UserProfile  
- One-to-Many with WorkoutSession

**Validation Rules**:
- `total_days` must be between 1-90 days
- `daily_schedules` length must equal `total_days`
- Only one program per user can be `is_active=true`
- `completion_percentage` calculated from completed sessions

### WorkoutSession
Represents individual workout instances with exercise sequences and timing.

**Fields**:
- `id` (UUID, Primary Key): Unique session identifier
- `program_id` (UUID, Foreign Key): Parent program reference
- `user_id` (UUID, Foreign Key): Session owner
- `created_at` (Timestamp): Session creation date
- `updated_at` (Timestamp): Last modification  
- `scheduled_date` (Date): Intended workout date
- `day_number` (Integer): Day within program (1-based)
- `workout_type` (Enum): "strength" | "cardio" | "rest" | "flexibility" | "mixed"
- `estimated_duration` (Integer): Expected minutes to complete
- `warmup_exercises` (JSON Array): Pre-workout exercise sequence
- `main_exercises` (JSON Array): Primary workout exercises with sets/reps/duration
- `cooldown_exercises` (JSON Array): Post-workout exercise sequence  
- `completion_status` (Enum): "scheduled" | "in_progress" | "completed" | "skipped"
- `started_at` (Timestamp): Actual start time
- `completed_at` (Timestamp): Actual completion time
- `performance_data` (JSON): Actual reps, weights, duration achieved

**Relationships**:
- Many-to-One with WorkoutProgram
- Many-to-One with UserProfile
- One-to-Many with WorkoutExercise (exercise instances)

**Validation Rules**:
- `day_number` must be within program's `total_days` range
- `scheduled_date` cannot be in the past when created
- `completion_status` transitions must be valid (scheduled → in_progress → completed)
- `performance_data` required when `completion_status = "completed"`

### ProgressRecord
Represents historical tracking data for performance analysis and motivation.

**Fields**:
- `id` (UUID, Primary Key): Unique record identifier
- `user_id` (UUID, Foreign Key): Record owner
- `created_at` (Timestamp): Record creation date
- `record_date` (Date): Date of tracked activity
- `record_type` (Enum): "workout_completion" | "strength_milestone" | "endurance_milestone" | "streak_achievement"
- `metric_name` (String): Specific metric being tracked
- `metric_value` (Float): Numerical value achieved
- `metric_unit` (String): Unit of measurement
- `context_data` (JSON): Additional context (exercise, program, equipment used)
- `milestone_type` (Enum): "personal_best" | "goal_achieved" | "streak_milestone" | "program_completion"
- `achievement_data` (JSON): Details about achievement and comparison to previous records

**Relationships**:
- Many-to-One with UserProfile
- Optional reference to WorkoutSession via context_data

**Validation Rules**:
- `record_date` cannot be in the future
- `metric_value` must be positive for most record types
- `context_data` must reference valid entities when provided
- Duplicate records for same user/date/metric prevented

## Supporting Entities

### ExerciseEquipment (Junction Table)
Links exercises to their equipment requirements.

**Fields**:
- `exercise_id` (UUID, Foreign Key)
- `equipment_id` (UUID, Foreign Key)  
- `requirement_type` (Enum): "required" | "optional" | "alternative"
- `usage_notes` (Text): How equipment is used in this exercise

### WorkoutExercise (Junction Table)
Represents exercise instances within workout sessions.

**Fields**:
- `id` (UUID, Primary Key)
- `session_id` (UUID, Foreign Key)
- `exercise_id` (UUID, Foreign Key)
- `sequence_order` (Integer): Order within workout
- `exercise_phase` (Enum): "warmup" | "main" | "cooldown"
- `target_sets` (Integer): Planned sets
- `target_reps` (Integer): Planned repetitions (null for duration-based)
- `target_duration` (Integer): Planned seconds (null for rep-based)
- `target_weight` (Float): Planned weight in kg (null if bodyweight)
- `rest_duration` (Integer): Rest seconds between sets
- `completed_sets` (Integer): Actually completed sets
- `performance_notes` (Text): User notes about performance
- `completion_status` (Enum): "pending" | "in_progress" | "completed" | "skipped"

## Relationships Summary

```
UserProfile 1─────────────∞ Equipment
     │                         │
     │                         │
     │                    ∞────┴────∞ Exercise
     │                              │
     │                              │
     ∞─────────────∞ WorkoutProgram │
     │                    │         │
     │                    │    ∞────┴────∞ WorkoutExercise
     │              ∞─────┴─────∞        │
     │                    │              │
     │              WorkoutSession ──────┘
     │                    
     ∞──── ProgressRecord
```

## Indexing Strategy

### Primary Indexes
- All primary keys (UUID) with B-tree indexes
- Foreign keys with B-tree indexes for joins
- Composite indexes on frequently queried combinations

### Performance Indexes
- `UserProfile.updated_at` - for sync conflict resolution
- `WorkoutSession.scheduled_date, user_id` - for daily workout queries
- `Exercise.muscle_groups, difficulty_level` - for AI exercise selection
- `Equipment.user_id, is_available` - for AI equipment matching
- `ProgressRecord.user_id, record_date` - for progress analytics

### Search Indexes  
- `Exercise.name, description` - full-text search for exercise discovery
- `WorkoutProgram.name, description` - program search functionality

## Data Consistency Rules

### Offline Sync Resolution
- **Conflict Resolution**: Last-write-wins based on `updated_at` timestamp
- **Tombstone Records**: Soft deletes with `deleted_at` timestamp for sync
- **Delta Sync**: Only sync changed records based on `updated_at` > last_sync_time
- **Constraint Validation**: Re-validate foreign key constraints after sync

### Business Logic Constraints
- User can have only one active WorkoutProgram at a time
- Equipment marked as unavailable excluded from AI generation
- WorkoutSession completion requires all exercises marked complete or skipped
- ProgressRecord timestamps must align with completed WorkoutSession dates

## Hybrid Storage Architecture

### Local Storage (Primary - Dexie.js/IndexedDB)
All data is stored locally first for instant access and offline capability:
```javascript
// Dexie.js schema matches Supabase schema 1:1
db.version(1).stores({
  userProfiles: '++id, email, updatedAt',
  equipment: '++id, userId, name, category, updatedAt, syncStatus',
  workoutPrograms: '++id, userId, name, isActive, updatedAt, syncStatus',
  workoutSessions: '++id, programId, scheduledDate, updatedAt, syncStatus',
  progressRecords: '++id, userId, recordDate, metricName, syncStatus'
});
```

### Cloud Storage (Optional - Supabase)
When enabled, data syncs to Supabase for backup and future multi-device support.
Sync is completely optional for personal use.

## Storage Estimates

### Record Counts (Personal Use - 2-3 users)
- UserProfile: 2-3 records
- Equipment: 10-30 items total  
- Exercise: ~500 exercises in global library
- WorkoutProgram: 10-20 active/historical programs per user
- WorkoutSession: 3-7 sessions per week per user = ~700-1000 sessions/year
- ProgressRecord: 1-5 records per session = ~3,500-5,000 records/year

### Storage Size (Year 1)
- Structured data: ~10-15MB (IndexedDB)
- Exercise demonstration media: ~200MB (cached in service worker)
- Total offline storage: ~215MB (well within PWA limits)
- Supabase usage: ~15MB (well within 500MB free tier)

## Migration Strategy

### Schema Versioning
- Semantic versioning for schema changes
- Backward compatibility for minor version updates
- Migration scripts for major version changes
- Feature flags for gradual rollout of schema changes

### Data Migration
- Export/import functionality for user data portability
- Schema migration tools for development environment updates
- Rollback procedures for failed migrations
- Data validation after each migration step

---

**Status**: ✅ Complete - Data model designed and ready for API contract generation
